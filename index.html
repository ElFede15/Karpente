<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Contable - Centro de Estudiantes</title>
    <style>
        /* Estilo general del cuerpo de la página */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: url('https://www.transparenttextures.com/patterns/diagonal-stripes.png');
            background-color: #f3e6f0;
            background-size: cover;
            color: #4b0082;
            transition: all 0.3s ease;
        }

        /* Estilo del encabezado */
        header {
            background-color: rgba(138, 43, 226, 0.8);
            color: #fff;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.5);
            border-bottom: 2px solid #9370db;
        }

        header h1 {
            font-size: 36px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Estilo del menú */
        #menu {
            background-color: rgba(147, 112, 219, 0.9);
            color: white;
            text-align: center;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 10px rgba(138, 43, 226, 0.5);
        }

        #menu a {
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: bold;
            margin: 0 15px;
            transition: color 0.3s ease;
        }

        #menu a:hover {
            color: #8a2be2;
            text-decoration: underline;
        }

        /* Estilo de los formularios */
        form {
            margin-top: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(147, 112, 219, 0.5);
        }

        form h2 {
            text-align: center;
            color: #8a2be2;
            font-size: 24px;
            font-weight: bold;
        }

        form input[type="number"], form input[type="text"], form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #8a2be2;
            border-radius: 10px;
            font-size: 16px;
            background-color: rgba(238, 230, 253, 0.8);
        }

        form button {
            background-color: #8a2be2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        form button:hover {
            background-color: #9370db;
        }

        /* Estilo de los elementos del historial */
        #historial {
            margin-top: 40px;
        }

        #historial h3 {
            text-align: center;
            font-size: 28px;
            color: #8a2be2;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.7);
        }

        #historial ul {
            list-style-type: none;
            padding: 0;
        }

        #historial li {
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            background-color: rgba(238, 230, 253, 0.7);
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.5);
            transition: transform 0.3s ease;
        }

        #historial li:hover {
            transform: scale(1.05);
        }

        /* Estilo de los botones y el balance */
        #balance {
            text-align: center;
            margin-top: 40px;
            font-weight: bold;
            font-size: 26px;
            color: #8a2be2;
        }

        #exportar-excel, #borrar-todo {
            background-color: #8a2be2;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
            border: none;
        }

        #exportar-excel:hover, #borrar-todo:hover {
            background-color: #9370db;
        }


    /* Contenedor del menú fuera del header */
    .menu-container {
            padding: 20px;
            text-align: center;
        }

        /* Menú de usuario */
        #user-name-btn {
            font-size: 18px;
            font-weight: bold;
            color: #880e4f;
            background-color: #f8bbd0; /* Rosa claro */
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #user-name-btn:hover {
            background-color: #f48fb1; /* Rosa un poco más oscuro */
        }

        /* Menú desplegable de opciones */
        #user-menu {
            display: none;
            background-color: #f8bbd0;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
            position: absolute;
            top: 60px; /* Asegura que esté debajo del nombre */
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #user-menu.show {
            opacity: 1;
            display: block;
        }

        /* Opciones dentro del menú */
        #user-menu button {
            background-color: #880e4f;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
        }

        #user-menu button:hover {
            background-color: #c2185b; /* Rosa más fuerte */
        }


        /* Estilo para el modal de confirmación */
#confirmacion-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro semitransparente */
    justify-content: center;
    align-items: center;
}

#confirmacion-modal.show {
    display: flex; /* Mostrar el modal cuando tiene la clase .show */
}

.modal-content {
    background-color: #ffffff;
    padding: 25px;
    border-radius: 15px;
    width: 300px;
    text-align: center;
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2); /* Sombra suave para iluminación */
    animation: fadeIn 0.3s ease-in-out; /* Animación para mostrar el modal */
}

/* Animación de aparición del modal */
@keyframes fadeIn {
    0% {
        opacity: 0;
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.modal-content h3 {
    color: #ff66b2; /* Rosa suave para el texto */
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    margin-bottom: 20px;
}

/* Estilo para los botones con líneas */
button#confirmar-borrar, button#cancelar-borrar {
    font-family: 'Poppins', sans-serif;
    padding: 12px 20px;
    background-color: transparent; /* Fondo transparente */
    border: 2px solid #ff66b2; /* Borde rosa suave */
    border-radius: 12px;
    color: #ff66b2; /* Color del texto rosa */
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Sombra suave */
}

/* Efecto hover para el botón Confirmar */
button#confirmar-borrar:hover {
    background-color: #ff66b2; /* Rosa de fondo cuando se pasa el ratón */
    color: white; /* Cambia el color del texto a blanco */
    border-color: #ff3385; /* Cambio de borde a un rosa más intenso */
    transform: scale(1.05); /* Efecto de aumento al pasar el ratón */
}

/* Efecto hover para el botón Cancelar */
button#cancelar-borrar:hover {
    background-color: #ff66b2; /* Rosa de fondo cuando se pasa el ratón */
    color: white; /* Cambia el color del texto a blanco */
    border-color: #ff3385; /* Cambio de borde a un rosa más intenso */
    transform: scale(1.05); /* Efecto de aumento al pasar el ratón */
}

/* Efecto active (cuando el usuario hace clic) */
button#confirmar-borrar:active, button#cancelar-borrar:active {
    transform: scale(0.98); /* Efecto de contracción al hacer clic */
}

/* Estilo para los botones cuando están en estado de hover y active */
button#confirmar-borrar:hover, button#cancelar-borrar:hover {
    transition: background-color 0.3s, transform 0.2s;
}



        /* Transiciones suaves */
        body, #menu, form, #historial {
            transition: all 0.5s ease;
        }
    </style>
</head>
<body>

    <header>
        <h1>Tesoreria - Centro de Estudiantes</h1>
    </header>

    <!-- Contenedor del menú -->
<div class="menu-container">
    <!-- Menú de usuario -->
    <button id="user-name-btn">Nombre del Usuario</button>

    <!-- Menú de opciones -->
    <div id="user-menu">
        <button id="cerrar-sesion">Cerrar sesión</button>
        <button id="exportar-historial">Exportar historial</button>
    </div>
</div>


    <main>
        <form id="form-ingresos">
            <label for="ingreso-descripcion">Tipo de ingreso:</label>
            <select id="ingreso-descripcion">
                <option value="" disabled selected style="color: #ff1493;">SELECCIONAR</option>
                <option value="Torneo de Truco">Torneo de Truco</option>
                <option value="Torneo de Ajedrez">Torneo de Ajedrez</option>
                <option value="Torneo de E-sports">Torneo de E-sports</option>
                <option value="Bingo">Bingo</option>
                <option value="Personalizado">Personalizado</option> <!-- Opción para ingreso personalizado -->
            </select>
            <div id="ingreso-personalizado-container" style="display: none;">
                <label for="ingreso-personalizado">Nombre del Ingreso Personalizado:</label>
                <input type="text" id="ingreso-personalizado" placeholder="Escribe el nombre del ingreso">
            </div>
            <label for="ingreso-cantidad">Cantidad de entradas:</label>
            <input type="number" id="ingreso-cantidad" placeholder="Cantidad">
            <label for="ingreso-precio">Precio por entrada:</label>
            <input type="number" id="ingreso-precio" placeholder="Precio">
            <button type="button" id="guardar-ingreso">Guardar Ingreso</button>
            <p id="error-ingreso" style="color: red; display: none;">Por favor, complete todos los campos correctamente.</p>
        </form>
    
        <h2>Formulario de Gastos</h2>
        <form id="form-gastos">
            <label for="gasto-descripcion">Tipo de gasto:</label>
            <select id="gasto-descripcion">
                <option value="" disabled selected style="color: #ff1493;">SELECCIONAR</option>
                <option value="Pintura">Pintura</option>
                <option value="Espejos de Plástico Reflectante">Espejos de Plástico Reflectante</option>
                <option value="Picaportes">Picaportes</option>
                <option value="Desodorantes de Ambiente">Desodorantes de Ambiente</option>
                <option value="Plantas">Plantas</option>
                <option value="Personalizado">Personalizado</option> <!-- Opción para gasto personalizado -->
            </select>
            <div id="gasto-personalizado-container" style="display: none;">
                <label for="gasto-personalizado">Nombre del Gasto Personalizado:</label>
                <input type="text" id="gasto-personalizado" placeholder="Escribe el nombre del gasto">
            </div>
            <label for="gasto-cantidad">Cantidad de unidades:</label>
            <input type="number" id="gasto-cantidad" placeholder="Cantidad">
            <label for="gasto-precio">Precio por unidad:</label>
            <input type="number" id="gasto-precio" placeholder="Precio">
            <button type="button" id="guardar-gasto">Guardar Gasto</button>
            <p id="error-gasto" style="color: red; display: none;">Por favor, complete todos los campos correctamente.</p>
        </form>

    
<div id="historial">
    <h3>Historial de Cálculos</h3>
    <ul id="historial-lista"></ul>
</div>

<div id="balance">
    Balance Total: <span id="balance-total">0</span>
</div>
<button type="button" id="exportar-excel">Exportar a Excel</button>
<button type="button" id="borrar-todo">Borrar Todo</button>
</main>

<div id="confirmacion-modal">
<div class="modal-content">
    <h3>¿Estás seguro de eliminar este movimiento?</h3>
    <button id="confirmar-borrar">Confirmar</button>
    <button id="cancelar-borrar">Cancelar</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script>
    // Mostrar/ocultar campos personalizados para ingresos
    document.getElementById('ingreso-descripcion').addEventListener('change', () => {
        const ingresoDescripcion = document.getElementById('ingreso-descripcion').value;
        document.getElementById('ingreso-personalizado-container').style.display = ingresoDescripcion === 'Personalizado' ? 'block' : 'none';
    });

    // Mostrar/ocultar campos personalizados para gastos
    document.getElementById('gasto-descripcion').addEventListener('change', () => {
        const gastoDescripcion = document.getElementById('gasto-descripcion').value;
        document.getElementById('gasto-personalizado-container').style.display = gastoDescripcion === 'Personalizado' ? 'block' : 'none';
    });

    // Función genérica para guardar ingresos o gastos en localStorage
    const guardarTransaccion = (tipo) => {
        const descripcionElem = document.getElementById(`${tipo}-descripcion`);
        let descripcion = descripcionElem.value === 'Personalizado' ? document.getElementById(`${tipo}-personalizado`).value : descripcionElem.value;
        const cantidad = parseFloat(document.getElementById(`${tipo}-cantidad`).value);
        const precio = parseFloat(document.getElementById(`${tipo}-precio`).value);
        const total = cantidad * precio;
        const fecha = new Date().toLocaleString();  // Fecha con hora y fecha exacta
        const usuario = JSON.parse(localStorage.getItem('user'))?.nombre || 'Invitado';

        if (!descripcion || isNaN(cantidad) || isNaN(precio) || cantidad <= 0 || precio <= 0) {
            document.getElementById(`error-${tipo}`).style.display = 'block';
            return;
        }

        const transaccion = { tipo, descripcion, cantidad, precio, total, fecha, usuario };
        const historial = JSON.parse(localStorage.getItem('historial')) || [];
        historial.push(transaccion);
        localStorage.setItem('historial', JSON.stringify(historial));

        actualizarHistorial();
        actualizarBalance();
        document.getElementById(`error-${tipo}`).style.display = 'none';
    };

    // Evento de clic para guardar ingresos y gastos
    document.getElementById('guardar-ingreso')?.addEventListener('click', () => {
        guardarTransaccion('ingreso');
        limpiarCampos('ingreso');
    });

    document.getElementById('guardar-gasto')?.addEventListener('click', () => {
        guardarTransaccion('gasto');
        limpiarCampos('gasto');
    });

    // Alternar visibilidad del menú de usuario
    document.getElementById('user-name-btn')?.addEventListener('click', () => {
        document.getElementById('user-menu').classList.toggle('show');
    });

    // Actualizar el nombre del usuario en el botón de usuario
    const actualizarNombreUsuario = () => {
        const usuario = JSON.parse(localStorage.getItem('user'))?.nombre || 'Invitado';
        document.getElementById('user-name-btn').textContent = usuario;
    };

    // Cerrar sesión
    document.getElementById('cerrar-sesion')?.addEventListener('click', () => {
        localStorage.removeItem('user');
        window.location.href = "login.html";
    });

    // Función para exportar historial
const exportarHistorial = (agrupado) => {
    const wb = XLSX.utils.book_new(); // Creamos un libro nuevo
    const wsHistorial = [["Tipo", "Descripción", "Cantidad", "Precio", "Total", "Fecha", "Usuario"]];
    const historial = JSON.parse(localStorage.getItem('historial')) || [];

    if (!historial.length) {
        alert('No hay datos para exportar.');
        return;
    }

    if (agrupado) {
        // Agrupar por descripción
        const historialAgrupado = historial.reduce((acc, item) => {
            acc[item.descripcion] = acc[item.descripcion] || [];
            acc[item.descripcion].push(item);
            return acc;
        }, {});

        // Recorremos las descripciones agrupadas y sumamos los valores
        Object.keys(historialAgrupado).forEach(descripcion => {
            const items = historialAgrupado[descripcion];
            const cantidadTotal = items.reduce((sum, item) => sum + item.cantidad, 0);
            const precioPromedio = items.reduce((sum, item) => sum + item.precio, 0) / items.length;
            const total = items.reduce((sum, item) => sum + item.total, 0);
            wsHistorial.push([items[0].tipo, descripcion, cantidadTotal, precioPromedio.toFixed(2), total.toFixed(2), items[0].fecha, items[0].usuario]);
        });
    } else {
        // Exportar todos los movimientos sin agrupar
        historial.forEach(item => {
            wsHistorial.push([item.tipo, item.descripcion, item.cantidad, item.precio.toFixed(2), item.total.toFixed(2), item.fecha, item.usuario]);
        });
    }

    const ws = XLSX.utils.aoa_to_sheet(wsHistorial);
    XLSX.utils.book_append_sheet(wb, ws, "Historial");
    XLSX.writeFile(wb, `historial_contable_${agrupado ? 'agrupado' : 'sin_agrupar'}.xlsx`);
};

// Eventos para exportar
document.getElementById('exportar-historial')?.addEventListener('click', () => exportarHistorial(false));  // Sin agrupar
document.getElementById('exportar-excel')?.addEventListener('click', () => exportarHistorial(true));   // Agrupado

    const limpiarCampos = (tipo) => {
        document.getElementById(`${tipo}-descripcion`).value = "";
        document.getElementById(`${tipo}-personalizado`).value = "";
        document.getElementById(`${tipo}-cantidad`).value = "";
        document.getElementById(`${tipo}-precio`).value = "";
        document.getElementById(`${tipo}-personalizado-container`).style.display = 'none';
    };

    const mostrarConfirmacion = (callback) => {
        const modal = document.getElementById('confirmacion-modal');
        modal.style.display = 'block';

        const confirmarBtn = document.getElementById('confirmar-borrar');
        const cancelarBtn = document.getElementById('cancelar-borrar');

        confirmarBtn.onclick = () => {
            callback();
            modal.style.display = 'none';
        };

        cancelarBtn.onclick = () => {
            modal.style.display = 'none';
        };
    };

    const borrarElemento = (index) => {
        mostrarConfirmacion(() => {
            let historial = JSON.parse(localStorage.getItem('historial')) || [];
            historial.splice(index, 1); // Eliminar el elemento seleccionado
            localStorage.setItem('historial', JSON.stringify(historial));
            actualizarHistorial();
            actualizarBalance();
        });
    };

    const borrarTodoHistorial = () => {
        mostrarConfirmacion(() => {
            localStorage.removeItem('historial');
            actualizarHistorial();
            actualizarBalance();
        });
    };

    document.getElementById('borrar-todo').addEventListener('click', borrarTodoHistorial);

    // Actualizar historial visualmente
    const actualizarHistorial = () => {
        const historialLista = document.getElementById('historial-lista');
        if (!historialLista) return;
        historialLista.innerHTML = '';
        const historial = JSON.parse(localStorage.getItem('historial')) || [];
        historial.forEach((item, index) => {
            const li = document.createElement('li');
            li.textContent = `${item.tipo}: ${item.descripcion} - Cantidad: ${item.cantidad} - Precio: $${item.precio.toFixed(2)} - Total: $${item.total.toFixed(2)} - Fecha: ${item.fecha} - Usuario: ${item.usuario}`;
            const btnBorrar = document.createElement('button');
            btnBorrar.textContent = 'Eliminar';
            btnBorrar.addEventListener('click', () => borrarElemento(index));
            li.appendChild(btnBorrar);
            historialLista.appendChild(li);
        });
    };

    // Función para actualizar el balance
    const actualizarBalance = () => {
        const balanceElem = document.getElementById('balance-total');
        if (!balanceElem) return;
        const historial = JSON.parse(localStorage.getItem('historial')) || [];
        let balanceTotal = historial.reduce((total, item) => total + (item.tipo === 'ingreso' ? item.total : -item.total), 0);
        balanceElem.textContent = balanceTotal.toFixed(2);
    };

    // Inicializar al cargar la página
    window.onload = () => {
        actualizarHistorial();
        actualizarBalance();
        actualizarNombreUsuario();  // Actualizar el nombre del usuario en el botón
        if (!localStorage.getItem('user')) {
            window.location.href = "login.html";
        }
    };
</script>


    
</body>
</html>